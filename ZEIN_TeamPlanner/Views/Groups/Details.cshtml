@using System.Security.Claims
@model ZEIN_TeamPlanner.Models.Group

@{
    ViewData["Title"] = Model.GroupName;
}

<h2>@Model.GroupName</h2>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="card">
    <div class="card-body">
        <h5 class="card-title">Group Details</h5>
        <dl class="row">
            <dt class="col-sm-3">Name</dt>
            <dd class="col-sm-9">@Model.GroupName</dd>
            <dt class="col-sm-3">Description</dt>
            <dd class="col-sm-9">@(Model.Description ?? "No description provided")</dd>
            <dt class="col-sm-3">Created By</dt>
            <dd class="col-sm-9">@Model.CreatedByUser?.FullName</dd>
            <dt class="col-sm-3">Created At</dt>
            <dd class="col-sm-9">@Model.CreateAt`.ToString("dd MMM yyyy")</dd>
        </dl>
    </div>
</div>

<h3 class="mt-4">Members</h3>
@if (Model.Members.Any(m => m.LeftAt == null))
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Joined At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var member in Model.Members.Where(m => m.LeftAt == null))
            {
                <tr>
                    <td>@member.User.FullName</td>
                    <td>@member.User.UserName</td>
                    <td>@member.Role</td>
                    <td>@member.JoinedAt.ToString("dd MMM yyyy")</td>
                    <td>
                        @if (ViewBag.IsAdmin && member.UserId != User.FindFirstValue(ClaimTypes.NameIdentifier))
                        {
                            <form asp-action="RemoveMember" method="post" class="d-inline">
                                <input type="hidden" name="groupId" value="@Model.GroupId" />
                                <input type="hidden" name="memberId" value="@member.UserId" />
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Bạn có chắc muốn xóa @member.User.FullName khỏi nhóm?')">Remove</button>
                            </form>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No members in this group.</p>
}

@if (ViewBag.IsAdmin)
{
    <h3 class="mt-4">Invite Member</h3>
    <form asp-action="InviteMember" method="post">
        <input type="hidden" name="groupId" value="@Model.GroupId" />
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" name="email" id="email" class="form-control" required />
            @* <label for="role">Role:</label>
            <select name="role" id="role" class="form-control">
                <option value="Member">Member</option>
                <option value="Admin">Admin</option>
            </select> *@
        </div>
        <button type="submit" class="btn btn-primary mt-2">Invite</button>
    </form>
}

<div class="mt-3">
    <a asp-controller="TaskItems" asp-action="Index" asp-route-groupId="@Model.GroupId" class="btn btn-info">View Tasks</a>
    <a asp-controller="CalendarEvents" asp-action="Index" asp-route-groupId="@Model.GroupId" class="btn btn-info">View Events</a>
    <a asp-action="Index" class="btn btn-primary">Back to Groups</a>
    @if (ViewBag.IsAdmin)
    {
        <a asp-action="Edit" asp-route-id="@Model.GroupId" class="btn btn-secondary">Edit Group</a>
        <a asp-action="Delete" asp-route-id="@Model.GroupId" class="btn btn-danger">Delete Group</a>
    }
    @if (!ViewBag.IsAdmin)
    {
        <form asp-action="LeaveGroup" method="post" class="d-inline">
            <input type="hidden" name="groupId" value="@Model.GroupId" />
            <button type="submit" class="btn btn-warning" onclick="return confirm('Bạn có chắc muốn rời nhóm @Model.GroupName?')">Leave Group</button>
        </form>
    }
</div>